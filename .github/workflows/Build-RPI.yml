# Verifies building

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          lfs: false
          submodules: false

      - uses: pguyot/arm-runner-action@v2
        with:
          cpu: "arm1176"
          cpu_info: "cpuinfo/raspberrypi_zero_w"
          base_image: "raspi_1_bullseye:latest"
          image_additional_mb: 8192

          commands: |
            sudo apt-get update
            sudo apt-get install -y build-essential pkg-config gcc g++ python3 python3-pip cmake libgl-dev libxcb-util-dev libx11-xcb-dev
            python3 -m pip install conan
            conan remote add grc ${{ secrets.CONAN_REMOTE_URL }} --force
            conan user -r grc ${{ secrets.CONAN_USER }} -p ${{ secrets.CONAN_PASSWORD }}
            conan remove "*" -f
            conan install . -if build -pr:h ConanProfiles/pib+-Release.ini -pr:b ConanProfiles/pib+-Release.ini -r grc -o dev="front" --build=missing -c tools.system.package_manager:mode=install -c tools.system.package_manager:sudo=True
            conan upload "*" -c --all --parallel -r grc
            conan build . -if build

      # - name: Build deploy bundle
      #   run: |
      #       wget -c -nv "https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage"
      #       wget -c -nv "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage"
      #       chmod a+x linuxdeploy-plugin-qt-x86_64.AppImage
      #       chmod a+x linuxdeploy-x86_64.AppImage
      #       export QML_SOURCES_PATHS=./src/Dash

      - name: Upload Build
        uses: actions/upload-artifact@v3
        with:
          name: RPI1.2b+DashFront-Release
          path: build/src/Dash/Release